<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bibek's Master Protocol | God Mode v3.12</title>
    <!-- Import modern fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default: Light Theme */
            --primary: #1e293b;
            --primary-light: #334155;
            --accent: #3b82f6; /* Modern Blue */
            --accent-glow: rgba(59, 130, 246, 0.5);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --special: #8b5cf6;
            --bg: #f1f5f9; /* Slate 100 */
            --paper: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-light: #64748b;
            --radius: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --gold: #f59e0b;
            
            /* Scheduler Colors */
            --sched-border: #cbd5e1;
            --sched-bg: #f8fafc;
            --sched-time-bg: #ffffff;

            /* Focus Mode Specifics */
            --focus-bg: #0f0f12;
            --focus-accent: #00f2ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- GLOBAL LAYOUT --- */
        .container {
            max-width: 1200px; /* Wider for routine */
            margin: 0 auto;
            background: var(--paper);
            padding: 40px;
            box-shadow: var(--shadow-lg);
            border-radius: 24px;
            overflow: hidden;
            position: relative;
            transition: background 0.3s ease;
        }

        /* --- HEADER --- */
        header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            margin: -40px -40px 30px -40px;
            padding: 40px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 24px 24px;
            opacity: 0.3;
        }
        
        h1 { 
            margin: 0; 
            font-family: 'Poppins', sans-serif; 
            font-size: 28px; 
            letter-spacing: -0.5px; 
            font-weight: 800; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .quote-box {
            margin-top: 10px;
            font-size: 13px;
            font-style: italic;
            opacity: 0.9;
            max-width: 500px;
            border-left: 3px solid var(--accent);
            padding-left: 10px;
            background: rgba(255,255,255,0.05);
            padding: 8px 12px;
            border-radius: 0 8px 8px 0;
        }

        .time-panel { text-align: right; position: relative; z-index: 2; display:flex; flex-direction: column; align-items: flex-end; }
        
        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        .theme-toggle:hover { background: rgba(255,255,255,0.2); }

        /* --- TABS --- */
        .tabs { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 30px; 
            padding: 6px;
            background: #e2e8f0;
            border-radius: 12px;
            width: fit-content;
        }
        .tab-btn {
            padding: 10px 24px;
            background: transparent;
            border: none;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tab-btn:hover { color: var(--text); background: rgba(255,255,255,0.5); }
        .tab-btn.active { 
            background-color: var(--paper); 
            color: var(--accent); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* --- SECTIONS (Shared) --- */
        .tracker-section {
            border: 1px solid var(--border);
            padding: 30px;
            margin-bottom: 25px;
            border-radius: var(--radius);
            background: var(--paper);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }
        .tracker-section:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .section-title {
            color: var(--primary);
            font-family: 'Poppins', sans-serif;
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 25px;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        .section-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(to right, var(--border), transparent);
            margin-left: 15px;
            border-radius: 2px;
        }

        /* --- FORMS & INPUTS --- */
        .input-group {
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        label { font-weight: 600; font-size: 14px; min-width: 140px; color: var(--text); }
        
        input[type="text"], input[type="number"], input[type="time"], select, textarea {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-family: inherit;
            background: var(--bg);
            color: var(--text);
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--paper);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        input[type="text"], textarea { flex-grow: 1; }
        textarea { resize: vertical; height: 80px; }
        input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--accent); cursor: pointer; }
        .goal-checkbox { width: 24px !important; height: 24px !important; accent-color: var(--success) !important; }

        .rating-display {
            font-weight: 800;
            color: var(--accent);
            margin-left: auto;
            background: var(--bg);
            padding: 8px 14px;
            border-radius: 8px;
            min-width: 70px;
            text-align: center;
            font-size: 14px;
            border: 1px solid var(--border);
            font-family: 'Poppins', sans-serif;
        }

        /* --- DASHBOARD --- */
        .score-dashboard {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 25px 35px;
            border-radius: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 40px;
            position: sticky;
            bottom: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .score-item { display: flex; flex-direction: column; }
        .score-val { font-size: 32px; font-weight: 900; font-family: 'Poppins', sans-serif; line-height: 1.2; }
        .score-label { font-size: 11px; text-transform: uppercase; opacity: 0.7; letter-spacing: 1px; font-weight: 700; }
        
        .xp-bar-container {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.1);
            height: 6px;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
            position: relative;
        }
        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            width: 0%;
            transition: width 1s ease;
        }
        .level-badge {
            font-size: 11px;
            background: var(--gold);
            color: #fff;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 800;
            margin-left: 8px;
            vertical-align: middle;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* --- ACTIONS --- */
        .action-bar { display: flex; gap: 15px; margin-top: 30px; }
        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            flex: 1;
            font-size: 13px;
            letter-spacing: 1px;
            transition: transform 0.1s, box-shadow 0.2s;
            font-family: 'Poppins', sans-serif;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-save { background: var(--success); color: white; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        .btn-clear { background: var(--paper); color: var(--danger); border: 2px solid var(--danger); }
        .btn-save:hover { background: #059669; transform: translateY(-1px); box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4); }

        /* --- ANIMATION --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse-border {
            0% { border-color: rgba(59, 130, 246, 0.4); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.2); }
            50% { border-color: rgba(59, 130, 246, 1); box-shadow: 0 0 15px 0 rgba(59, 130, 246, 0.4); }
            100% { border-color: rgba(59, 130, 246, 0.4); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.2); }
        }

        /* --- ROUTINE STYLES --- */
        .routine-container {
            overflow-x: auto;
            margin-top: 10px;
            background: var(--bg);
            border-radius: 20px;
            padding: 10px;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }
        .routine-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 8px; 
            min-width: 1200px;
            color: var(--text);
        }
        .routine-table th {
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 800;
            font-size: 12px;
            font-family: 'Poppins', sans-serif;
            padding: 15px;
            color: var(--text-light);
            text-align: center;
            border-radius: 12px;
            background: transparent;
        }
        .routine-table td:first-child {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
            background: transparent;
            position: sticky;
            left: 0;
            z-index: 10;
            white-space: nowrap;
            text-align: right;
            padding-right: 15px;
            vertical-align: middle;
            border: none;
            width: 120px;
        }
        .routine-table td:first-child::after {
            content: '';
            position: absolute;
            right: 0;
            top: 10%;
            bottom: 10%;
            width: 2px;
            background: var(--border);
            border-radius: 2px;
        }
        .routine-table td:not(:first-child) {
            padding: 0;
            vertical-align: top;
            height: 100px;
        }
        .rt-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding: 12px 15px;
            height: 100%;
            width: 100%;
            border-radius: 12px;
            position: relative;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            box-sizing: border-box;
            overflow: hidden;
        }
        .rt-card:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.08); z-index: 20; }
        .rt-empty { background: transparent; border: 1px dashed var(--border); opacity: 0.3; border-radius: 12px; }
        .rt-title { font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 13px; line-height: 1.3; margin-bottom: 4px; width: 100%; }
        .rt-sub { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 500; opacity: 0.85; display: flex; align-items: center; gap: 4px; }
        .bg-morning { background: #e0f2f1; color: #004d40; border-left: 4px solid #009688; }
        .bg-lecture { background: #e3f2fd; color: #0d47a1; border-left: 4px solid #2196f3; }
        .bg-deep { background: #eef2ff; color: #312e81; border-left: 4px solid #6366f1; }
        .bg-phys { background: #ecfdf5; color: #064e3b; border-left: 4px solid #10b981; }
        .bg-code { background: #fffbeb; color: #78350f; border-left: 4px solid #f59e0b; }
        .bg-break { background: #f1f5f9; color: #475569; border-left: 4px solid #94a3b8; }
        .bg-special { background: #fff1f2; color: #881337; border-left: 4px solid #f43f5e; }
        .bg-night { background: #1e293b; color: #f8fafc; border-left: 4px solid #475569; }
        .active-day-header { color: var(--accent) !important; position: relative; }
        .active-day-header::after { content: '‚óè'; font-size: 8px; position: absolute; top: 0; right: 50%; transform: translateX(50%); }
        .active-routine-cell { animation: pulse-border 2s infinite; z-index: 10; border: 2px solid var(--accent) !important; }
        .active-routine-cell::before { content: 'ACTIVE'; position: absolute; top: 6px; right: 6px; background: var(--accent); color: white; font-size: 8px; font-weight: 800; padding: 2px 6px; border-radius: 4px; font-family: 'Inter', sans-serif; }

        /* Focus Mode UI */
        #focusView { display: none; animation: fadeIn 0.4s ease; }
        .focus-container {
            background: #0f0f12; border-radius: 24px; padding: 40px; color: white; text-align: center; position: relative; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 30px 60px rgba(0,0,0,0.5); min-height: 500px; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .focus-bg-glow {
            position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, rgba(0, 242, 255, 0.1) 0%, rgba(0,0,0,0) 70%);
            top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 0;
        }
        .focus-content { position: relative; z-index: 1; width: 100%; max-width: 500px; }
        .timer-wrapper { margin: 40px 0; position: relative; }
        #timerDisplay { font-family: 'JetBrains Mono', monospace; font-size: 100px; font-weight: 700; color: #ffffff; text-shadow: 0 0 30px rgba(0, 242, 255, 0.6); line-height: 1; letter-spacing: -2px; }
        .timer-status-text { color: var(--focus-accent); text-transform: uppercase; letter-spacing: 4px; font-size: 12px; margin-top: 10px; opacity: 0.8; font-weight: 600; }
        .focus-controls { display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; }
        .btn-focus {
            width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-focus:hover { transform: scale(1.1); background: rgba(255,255,255,0.2); }
        .btn-focus.start { background: var(--focus-accent); color: #000; box-shadow: 0 0 20px rgba(0, 242, 255, 0.4); }
        .btn-focus.stop { color: var(--danger); }
        .focus-target-select {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); padding: 10px 20px; border-radius: 30px; font-family: 'Inter', sans-serif; font-size: 14px; outline: none; cursor: pointer; text-align: center; margin-bottom: 20px; appearance: none;
        }
        .zen-toggle-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.5); padding: 8px 16px; border-radius: 8px; font-size: 11px; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .zen-toggle-btn:hover { color: white; border-color: white; }
        
        .zen-mode-active {
            position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; 
            z-index: 9999 !important; margin: 0 !important; border-radius: 0 !important; 
            background: radial-gradient(circle at center, #1a1a1d 0%, #000000 100%) !important;
            display: flex !important; flex-direction: column; justify-content: center; align-items: center; 
        }
        .zen-mode-active #timerDisplay { font-size: 18vw; text-shadow: 0 0 50px rgba(0,242,255,0.4); }
        .zen-mode-active .zen-close-btn { display: block; }
        .zen-close-btn { display: none; position: absolute; top: 30px; right: 30px; background: rgba(255,255,255,0.1); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; z-index: 10; }

        /* --- UPGRADED HISTORY ANALYTICS UI (v3.8) --- */
        #historyView { display: none; animation: fadeIn 0.4s ease; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .history-actions { display: flex; gap: 10px; }
        .btn-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); cursor: pointer; font-size: 16px; transition: all 0.2s; }
        .btn-icon:hover { background: var(--paper); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--paper); border: 1px solid var(--border); padding: 20px; border-radius: 16px; text-align: left; position: relative; overflow: hidden; box-shadow: var(--shadow-sm); }
        .stat-val { font-size: 24px; font-weight: 800; color: var(--primary); margin-bottom: 5px; font-family: 'Poppins', sans-serif; }
        .stat-lbl { font-size: 12px; color: var(--text-light); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-icon { position: absolute; right: 20px; top: 20px; font-size: 20px; opacity: 0.1; }
        .stat-trend { font-size: 11px; font-weight: 700; margin-top: 5px; display: block; }
        .trend-up { color: var(--success); } .trend-down { color: var(--danger); } .trend-flat { color: var(--text-light); }

        /* Analytics Grid Layout */
        .analytics-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: auto auto;
            gap: 25px;
            margin-bottom: 25px;
        }
        @media (max-width: 800px) { .analytics-grid { grid-template-columns: 1fr; } }

        .chart-box {
            background: var(--paper);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
        }
        .chart-box h3 { margin: 0 0 15px 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); font-weight: 800; display:flex; justify-content:space-between; align-items:center; }
        
        /* Main Trend Chart */
        .chart-main { grid-column: 1 / -1; height: 320px; }
        
        /* Radar & Heatmap */
        .chart-radar { height: 350px; position:relative; }
        .chart-heatmap { height: 350px; }

        canvas { width: 100%; height: 100%; }

        /* Heatmap Grid */
        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-top: 10px;
        }
        .hm-cell {
            aspect-ratio: 1;
            border-radius: 6px;
            background: var(--bg);
            border: 1px solid var(--border);
            position: relative;
            transition: transform 0.2s;
        }
        .hm-cell:hover { transform: scale(1.1); z-index: 2; border-color: var(--text); }
        .hm-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 4px 8px; font-size: 10px; border-radius: 4px; display: none; white-space: nowrap; pointer-events: none; }
        .hm-cell:hover .hm-tooltip { display: block; }
        
        /* Heatmap Colors */
        .hm-l0 { background-color: #f1f5f9; }
        .hm-l1 { background-color: #bbf7d0; border-color: #86efac; }
        .hm-l2 { background-color: #4ade80; border-color: #22c55e; }
        .hm-l3 { background-color: #16a34a; border-color: #15803d; }
        .hm-l4 { background-color: #14532d; border-color: #052e16; } /* Max Intensity */

        /* Insight Box */
        .insight-box {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid var(--border);
            border-left: 4px solid var(--special);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-size: 13px;
            color: var(--text);
            display: flex; align-items: center; gap: 15px;
        }
        .insight-icon { font-size: 24px; }

        /* Data Table */
        .table-container { border-radius: 16px; border: 1px solid var(--border); overflow: hidden; background: var(--paper); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .history-table th { background: var(--bg); color: var(--text-light); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 16px; text-align: left; font-size: 11px; border-bottom: 1px solid var(--border); }
        .history-table td { padding: 16px; border-bottom: 1px solid var(--border); color: var(--text); }
        .status-pill { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .action-cell { display: flex; gap: 8px; }
        .table-btn { background: transparent; border: none; cursor: pointer; font-size: 14px; opacity: 0.6; transition: opacity 0.2s; padding: 4px; }
        
        #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        @media (prefers-color-scheme: dark) { }
    </style>
</head>
<body>

<canvas id="confettiCanvas"></canvas>

<div class="container">
    <header>
        <div>
            <h1>Daily Tracker v3.12</h1>
            <h2>Bibek Subedi | Final Year Civil Engineering Studnet </h2>
            <div id="quoteDisplay" class="quote-box">Loading Wisdom...</div>
        </div>
        <div class="time-panel">
            <button class="theme-toggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
            <div id="clockDisplay" style="font-size: 2.2em; font-weight: 700; font-family: 'Poppins'; margin-bottom: 5px; line-height: 1;">00:00:00</div>
            <div id="currentDateDisplay" style="font-size: 0.9em; opacity: 0.8; font-weight: 500; text-transform: uppercase; letter-spacing: 1px;">Date</div>
            <div id="currentActivityBadge" class="now-badge">Syncing...</div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tracker')">Daily Tracker</button>
        <button class="tab-btn" onclick="switchTab('focus')">Focus Mode</button>
        <button class="tab-btn" onclick="switchTab('history')">History & Analytics</button>
        <button class="tab-btn" onclick="switchTab('routine')">Master Routine</button>
    </div>

    <!-- TRACKER TAB -->
    <div id="trackerView" style="animation: fadeIn 0.4s ease;">
        <form id="trackerForm">
            <div class="tracker-section" style="border-top: 4px solid #a55eea;">
                <div class="section-title" style="color: #a55eea;">üèóÔ∏è Grand Strategy</div>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; margin-bottom: 5px;">
                        <span>HEC-RAS 100-Day Challenge</span>
                        <span id="hecPercent">Day 0</span>
                    </div>
                    <input type="range" id="hecProgress" min="0" max="100" value="0" oninput="updateLongTerm('hec', this.value)" style="width:100%">
                </div>
            </div>

            <div class="tracker-section">
                <div class="section-title">‚öîÔ∏è Daily Missions</div>
                <div class="input-group">
                    <label>1. Top Priority:</label>
                    <input type="text" id="goal1" placeholder="Main priority...">
                    <input type="checkbox" id="goal1_done" class="goal-checkbox" onchange="calculateAll()">
                </div>
                <div class="input-group">
                    <label>2. Secondary:</label>
                    <input type="text" id="goal2" placeholder="Secondary task...">
                    <input type="checkbox" id="goal2_done" class="goal-checkbox" onchange="calculateAll()">
                </div>
                <div class="input-group">
                    <label>3. Life/Admin:</label>
                    <input type="text" id="goal3" placeholder="Life/Admin task...">
                    <input type="checkbox" id="goal3_done" class="goal-checkbox" onchange="calculateAll()">
                </div>
                <div style="text-align: right; font-size: 13px; color: var(--success); font-weight: 800;">
                    EXECUTION SCORE: +<span id="goalScore">0</span>
                </div>
            </div>

            <div class="tracker-section">
                <div class="section-title">üåÖ Morning Protocol</div>
                <div class="input-group">
                    <label>Wake Up Time:</label>
                    <input type="time" id="wakeTime" onchange="calculateAll()">
                    <span class="rating-display"><span id="wakeScore">0</span> pts</span>
                </div>
                <div class="input-group">
                    <label>Meditation/Exercise:</label>
                    <input type="number" id="meditationTime" placeholder="Minutes" oninput="calculateAll()">
                    <span class="rating-display"><span id="meditationScore">0</span> / 15</span>
                </div>
                <div class="input-group">
                    <label>Breakfast Quality:</label>
                    <select id="breakfastRating" onchange="calculateAll()">
                        <option value="5">Excellent (5)</option>
                        <option value="4">Good (4)</option>
                        <option value="3">Average (3)</option>
                        <option value="2">Poor (2)</option>
                        <option value="1">Skipped (1)</option>
                        <option value="0">None (0)</option>
                    </select>
                    <span class="rating-display"><span id="breakfastScore">0</span> / 5</span>
                </div>
                <div class="input-group">
                    <label>Morning Energy:</label>
                    <div style="flex-grow: 1; padding: 0 10px;">
                        <input type="range" id="energyLevel" min="1" max="10" value="7" oninput="document.getElementById('energyDisp').innerText = this.value;">
                    </div>
                    <span class="rating-display">‚ö° <span id="energyDisp">7</span></span>
                </div>
            </div>

            <div class="tracker-section">
                <div class="section-title">üß† Deep Work Sessions</div>
                <div class="input-group">
                    <label style="color:var(--accent);">Session I(Skill/Literature):</label>
                    <input type="number" id="s1_time" placeholder="Mins (Target 120)" oninput="calculateAll()" style="width: 100px;">
                    <input type="number" id="s1_acc" placeholder="Done %" oninput="calculateAll()" style="width: 100px;">
                    <span class="rating-display"><span id="s1_score">0</span> / 30</span>
                </div>
                <div class="input-group">
                    <label>Session II (Skill Devlopment):</label>
                    <input type="number" id="s2_time" placeholder="Mins (Target 120)" oninput="calculateAll()" style="width: 100px;">
                    <input type="number" id="s2_acc" placeholder="Done %" oninput="calculateAll()" style="width: 100px;">
                    <span class="rating-display"><span id="s2_score">0</span> / 30</span>
                </div>
                <div class="input-group">
                    <label>Session III (Python/ML):</label>
                    <input type="number" id="s3_time" placeholder="Mins (Target 90)" oninput="calculateAll()" style="width: 100px;">
                    <input type="number" id="s3_acc" placeholder="Done %" oninput="calculateAll()" style="width: 100px;">
                    <span class="rating-display"><span id="s3_score">0</span> / 30</span>
                </div>
            </div>

            <div class="tracker-section">
                <div class="section-title">üîã Biology & Lifestyle</div>
                <div class="input-group">
                    <label>Fuel (Diet):</label>
                    <div style="flex-grow: 1; padding: 0 10px;">
                        <input type="range" id="dietScoreInput" min="0" max="10" value="5" oninput="document.getElementById('dietDisp').innerText = this.value; calculateAll();" style="width:100%">
                    </div>
                    <span class="rating-display"><span id="dietDisp">5</span> / 10</span>
                </div>
                <div class="input-group">
                    <label>Hydration:</label>
                    <div style="flex-grow: 1; padding: 0 10px;">
                        <input type="range" id="waterIntake" min="0" max="5" step="0.5" value="2.5" oninput="document.getElementById('waterDisp').innerText = this.value; calculateAll();" style="width:100%">
                    </div>
                    <span class="rating-display">üíß <span id="waterDisp">2.5</span> L</span>
                    <span class="rating-display" style="background:transparent; color: var(--success); border:none;">+<span id="waterScore">0</span></span>
                </div>
                <div class="input-group">
                    <label>Meds Protocol:</label>
                    <div style="flex-grow: 1; display: flex; gap: 20px; align-items: center;">
                        <label style="min-width: auto; font-weight: 500; cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="med_morning" onchange="calculateAll()"> Morning Only (Daily)
                        </label>
                    </div>
                    <span class="rating-display" style="color: var(--success); border-color: var(--success);">+<span id="medScore">0</span></span>
                </div>
                <div class="input-group">
                    <label>Screen Time (Hrs):</label>
                    <input type="number" id="screenHours" step="0.1" placeholder="Hours" oninput="calculateAll()">
                    <span class="rating-display"><span id="screenScore">25</span> / 25</span>
                </div>
                <div class="input-group">
                    <label>Research (Bonus):</label>
                    <input type="number" id="researchN" placeholder="Items Read" oninput="calculateAll()">
                    <span class="rating-display" style="color: var(--success); border-color: var(--success);">+<span id="researchScore">0</span></span>
                </div>
            </div>

            <div class="tracker-section" style="border-left: 4px solid var(--danger);">
                <div class="section-title" style="color: var(--danger);">Fresh Mode Protocol</div>
                <div class="input-group">
                    <label>Status:</label>
                    <select id="maturitylevel" onchange="calculateAll()" style="color: var(--text); font-weight: 500;">
                        <option value="10">üî•Super Cool (+10)</option>
                        <option value="0">üòêRetained after Bad (+0)</option>
                        <option value="-10">üò´Bad (-10)</option>
                        <option value="-20">üò§Very Bad (-20)</option>
                    </select>
                    <span class="rating-display" style="color: var(--danger); background: var(--bg); border-color: var(--danger);"><span id="habitScore">0</span></span>
                </div>
                <div class="input-group">
                    <label>Discipline Rules:</label>
                    <div style="flex-grow: 1; display: flex; gap: 20px;">
                        <label style="min-width: auto; font-weight: 500; font-size: 13px;"><input type="checkbox" id="rule_bed" onchange="calculateAll()"> No Bed (Day)</label>
                        <label style="min-width: auto; font-weight: 500; font-size: 13px;"><input type="checkbox" id="rule_room" onchange="calculateAll()"> Out till 5PM</label>
                    </div>
                </div>
            </div>

            <div class="tracker-section">
                <div class="section-title">üò¥ Sleep Hygiene</div>
                <div class="input-group">
                    <label>In Bed By:</label>
                    <input type="time" id="bedTime" onchange="calculateAll()">
                    <span class="rating-display"><span id="sleepScore">0</span> / 15</span>
                </div>
            </div>

            <div class="tracker-section">
                <div class="section-title">üî¨ Protocol Observations</div>
                <div class="input-group">
                    <label>Day Tags:</label>
                    <input type="text" id="dayTags" placeholder="#Sick #Exam #Productive">
                </div>
                <div class="input-group">
                    <label style="color: var(--success);">üèÜ Top Win:</label>
                    <input type="text" id="topWin" placeholder="Accomplishment...">
                </div>
                <div class="input-group">
                    <label style="color: var(--danger);">üöß Main Obstacle:</label>
                    <input type="text" id="mainObstacle" placeholder="Blocker...">
                </div>
            </div>

            <div class="score-dashboard">
                <div class="score-item">
                    <div class="score-label">Daily Score</div>
                    <div class="score-val" id="totalScore">0</div>
                </div>
                <div class="score-item" style="text-align: center;">
                    <div class="score-label">Streak</div>
                    <div class="score-val" id="streakCount">0</div>
                </div>
                <div class="score-item" style="text-align: right;">
                    <div class="score-label">Status</div>
                    <div class="score-val" id="statusText" style="font-size: 20px;">--</div>
                </div>
                <div class="xp-bar-container">
                    <div class="xp-bar-fill" id="xpBarFill"></div>
                </div>
                <div style="grid-column: 1/-1; display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.7);">
                    <span id="currentLevelText">Lvl 1</span>
                    <span><span id="currentXP">0</span> / 500 XP to Next</span>
                </div>
            </div>

            <div class="action-bar">
                <button type="button" class="btn btn-save" onclick="saveData()">üíæ Save & Sync</button>
                <button type="button" class="btn btn-clear" onclick="resetForm()">üîÑ Reset</button>
            </div>
        </form>
    </div>

    <!-- FOCUS MODE TAB -->
    <div id="focusView">
        <div id="focusModeContainer" class="focus-container">
            <button class="zen-close-btn" onclick="toggleZenMode()">EXIT ZEN (ESC)</button>
            <div class="focus-bg-glow"></div>
            <div class="focus-content">
                <div class="section-title" style="color: var(--focus-accent); justify-content: center; border: none; font-size: 16px;">
                    ‚ö° DEEP WORK PROTOCOL
                </div>
                <div class="timer-wrapper">
                    <div id="timerDisplay">00:00</div>
                    <div class="timer-status-text" id="timerStatus">Ready to Engage</div>
                </div>
                <select id="timerTarget" class="focus-target-select">
                    <option value="s1_time">üéØ Session I: Literature Reviews</option>
                    <option value="s2_time">üõ†Ô∏è Session II: Skill Development</option>
                    <option value="s3_time">üêç Session III: Python/ML</option>
                </select>
                <div class="focus-controls">
                    <button type="button" class="btn-focus stop" onclick="stopTimer()" title="Log & Finish">‚óº</button>
                    <button type="button" class="btn-focus start" onclick="startTimer()" title="Start Focus">‚ñ∂</button>
                    <button type="button" class="btn-focus" onclick="pauseTimer()" title="Pause">‚ùö‚ùö</button>
                </div>
                <button class="zen-toggle-btn" onclick="toggleZenMode()">‚õ∂ Enter Zen Mode</button>
            </div>
        </div>
    </div>

    <!-- UPDATED HISTORY TAB (v3.12) -->
    <div id="historyView">
        <div class="history-header">
            <div class="section-title" style="margin: 0; border: none;">üìä Analytical Command Center</div>
            <div class="history-actions">
                <button class="btn-icon" title="Import JSON" onclick="importJSON()">üì•</button>
                <button class="btn-icon" title="Export Excel" onclick="exportToExcel()">üìä</button>
                <button class="btn-icon" title="Export JSON" onclick="exportJSON()">üì§</button>
                <button class="btn-icon" title="Wipe Data" style="color:var(--danger); border-color:var(--danger);" onclick="clearHistory()">üóëÔ∏è</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-val" id="wkAvgScore">0</div>
                <div class="stat-lbl">7-Day Avg Score</div>
                <span class="stat-trend" id="trendScore">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üß†</div>
                <div class="stat-val" id="wkTotalDeep">0</div>
                <div class="stat-lbl">Deep Work Hours</div>
                <span class="stat-trend" id="trendWork">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üò¥</div>
                <div class="stat-val" id="wkAvgSleep">0</div>
                <div class="stat-lbl">Avg Sleep Score</div>
                <span class="stat-trend" id="trendSleep">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-val" id="wkBestDay">--</div>
                <div class="stat-lbl">Best Streak Day</div>
            </div>
        </div>

        <!-- Advanced Analytics Grid -->
        <div class="analytics-grid">
            <!-- 1. Main Trend Chart -->
            <div class="chart-box chart-main">
                <h3>Performance Trend <span style="font-size:10px; opacity:0.6;">(History)</span></h3>
                <canvas id="trendCanvas"></canvas>
            </div>

            <!-- 2. Radar Chart -->
            <div class="chart-box chart-radar">
                <h3>Pentagon of Power <span style="font-size:10px; opacity:0.6;">(Life Balance)</span></h3>
                <canvas id="radarCanvas"></canvas>
            </div>

            <!-- 3. Heatmap -->
            <div class="chart-box chart-heatmap">
                <h3>Consistency Heatmap <span style="font-size:10px; opacity:0.6;">(Last 30 Days)</span></h3>
                <div id="heatmapContainer" class="heatmap-container">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>

        <!-- Automated Insight -->
        <div class="insight-box">
            <div class="insight-icon">üí°</div>
            <div id="aiInsightText">Insufficient data to generate correlations. Log at least 2 days of data.</div>
        </div>

        <div class="table-container">
            <div style="overflow-x: auto;">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Wake</th>
                            <th>Work</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Obstacle</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ROUTINE TAB -->
    <div id="routineView" style="display:none; animation: fadeIn 0.4s ease;">
        <div class="tracker-section" style="padding: 20px; background: transparent; border: none; box-shadow: none;">
            <div class="section-title">Master Routine (Effective 2081 Mangsir)</div>
            <div class="routine-container">
                <table class="routine-table">
                    <thead>
                        <tr>
                            <th style="width: 100px;">Time</th>
                            <th style="width: 13%;">Sun</th>
                            <th style="width: 13%;">Mon</th>
                            <th style="width: 13%;">Tue</th>
                            <th style="width: 13%;">Wed</th>
                            <th style="width: 13%;">Thu</th>
                            <th style="width: 13%;">Fri</th>
                            <th style="width: 12%;">Sat</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 06:00 -->
                        <tr id="row-06">
                            <td>06:00 - 07:00</td>
                            <td colspan="6"><div class="rt-card bg-morning"><div class="rt-title">Morning Protocol</div><div class="rt-sub">Wake ‚Ä¢ Hydrate ‚Ä¢ Cold Shower</div></div></td>
                            <td><div class="rt-card bg-special"><div class="rt-title">Hike Prep</div><div class="rt-sub">Pack & Ready</div></div></td>
                        </tr>
                        <!-- 07:00 -->
                        <tr id="row-07-a">
                            <td>07:00 - 07:15</td>
                            <td colspan="6"><div class="rt-card bg-break"><div class="rt-title">Travel</div><div class="rt-sub">Morning</div></div></td>
                            
                            <td rowspan="4"><div class="rt-card bg-special" style="height:100%; justify-content:center;"><div class="rt-title">HIKING / SPORT</div><div class="rt-sub">07:00 - 11:00</div></div></td>
                        </tr>

                        <tr id="row-07-b">
                            <td>07:15 - 08:45</td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">GIS & Remote Sensing</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">GroundWater Engineering</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">GIS & Remote Sensing</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">GroundWater Engineering</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">GIS & Remote Sensing</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">GroundWater Engineering</div></div></td>
                        </tr>
                        <!-- 08:45 -->
                        <tr id="row-08">
                            <td>08:45 - 10:15</td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">Computational Technique</div><div class="rt-sub">RKR</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">Computational Technique </div><div class="rt-sub">SKSah</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">Construction Management</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">Tech. Env. & Society</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">Engg. Prof. Practice</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">Computational Technique </div><div class="rt-sub">SKSah</div></div></td>
                        </tr>
                        <!-- 10:15 -->
                        <tr id="row-10">
                            <td>10:15 - 11:00</td>
                            <td colspan="6"><div class="rt-card bg-break"><div class="rt-title">Break / Socialize</div></div></td>
                        </tr>
                        <!-- 11:00 -->
                        <tr id="row-11">
                            <td>11:00 - 12:30</td>
                            <td><div class="rt-card bg-deep"><div class="rt-title">Literature Review</div><div class="rt-sub">Library</div></div></td>
                            <td><div class="rt-card bg-deep"><div class="rt-title">Skills Dev.</div><div class="rt-sub">Library</div></div></td>
                            <td><div class="rt-card bg-deep"><div class="rt-title">Literature Review</div><div class="rt-sub">Library</div></div></td>
                            <td><div class="rt-card bg-deep"><div class="rt-title">Skills Dev.</div><div class="rt-sub">Library</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">Construction Management</div></div></td>
                            <td><div class="rt-card bg-lecture"><div class="rt-title">Construction Management</div></div></td>
                            <td><div class="rt-card rt-empty"></div></td>
                        </tr>
                        <!-- 12:30 -->
                        <tr id="row-12">
                            <td>12:30 - 01:30</td>
                            <td colspan="7"><div class="rt-card" style="background:#e2e8f0; color:#475569; border:none;"><div class="rt-title" style="text-align:center;">LUNCH</div></div></td>
                        </tr>
                        <!-- 01:30 -->
                        <tr id="row-13">
                            <td>01:30 - 02:30</td>
                            <td colspan="6"><div class="rt-card bg-lecture"><div class="rt-title">HEC-RAS HOUR</div><div class="rt-sub">Comp Lab</div></div></td>
                            <td><div class="rt-card bg-special"><div class="rt-title">Social</div></div></td>
                        </tr>
                        <!-- 02:30 -->
                        <tr id="row-14">
                            <td>02:30 - 04:30</td>
                            <td><div class="rt-card bg-deep"><div class="rt-title">GIS</div></div></td>
                            <td><div class="rt-card bg-deep"><div class="rt-title">Assignments</div></div></td>
                            <td><div class="rt-card bg-deep"><div class="rt-title">GIS</div></div></td>
                            <td><div class="rt-card bg-deep"><div class="rt-title">Assignments</div></div></td>
                            <td><div class="rt-card bg-deep"><div class="rt-title">MHM </div></div></td>
                            <td><div class="rt-card bg-deep"><div class="rt-title">MHM </div></div></td>
                            <td><div class="rt-card rt-empty"></div></td>
                        </tr>
                        <!-- 04:30 -->
                        <tr id="row-16">
                            <td>04:30 - 05:30</td>
                            <td colspan="6"><div class="rt-card bg-break"><div class="rt-title">Commute</div><div class="rt-sub">Podcast / Read</div></div></td>
                            <td><div class="rt-card rt-empty"></div></td>
                        </tr>
                        <!-- 05:30 -->
                        <tr id="row-17">
                            <td>05:30 - 07:00</td>
                            <td colspan="7"><div class="rt-card bg-phys"><div class="rt-title">GYM / SPORT</div><div class="rt-sub">Physical Training</div></div></td>
                        </tr>
                        <!-- 07:00 -->
                        <tr id="row-19">
                            <td>07:00 - 08:00</td>
                            <td colspan="7"><div class="rt-card bg-morning"><div class="rt-title">Dinner / Shower</div></div></td>
                        </tr>
                        <!-- 08:00 -->
                        <tr id="row-20">
                            <td>08:00 - 09:00</td>
                            <td><div class="rt-card bg-code"><div class="rt-title">Pandas</div></div></td>
                            <td><div class="rt-card bg-code"><div class="rt-title">ML</div></div></td>
                            <td><div class="rt-card bg-code"><div class="rt-title">GeoPandas</div></div></td>
                            <td><div class="rt-card bg-code"><div class="rt-title">ML</div></div></td>
                            <td><div class="rt-card bg-code"><div class="rt-title">Geopandas</div></div></td>
                            <td><div class="rt-card bg-code"><div class="rt-title">ML</div></div></td>
                            <td><div class="rt-card bg-code"><div class="rt-title">Pandas</div></div></td>
                        </tr>
                        <!-- 09:00 -->
                        <tr id="row-21">
                            <td>09:00 - 09:30</td>
                            <td colspan="7"><div class="rt-card bg-break"><div class="rt-title">RELAX</div><div class="rt-sub">Screen Feed</div></div></td>
                        </tr>
                        <!-- 09:30 -->
                        <tr id="row-22">
                            <td>09:30 - 10:00</td>
                            <td colspan="7"><div class="rt-card bg-night"><div class="rt-title">Digital Sunset</div><div class="rt-sub">Sleep Protocol</div></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    // --- 1. INITIALIZATION ---
    const INDEX_KEY = 'tracker_registry_v2'; 
    const OLD_INDEX_KEY = 'tracker_dates';
    const todayKey = new Date().toISOString().split('T')[0]; 
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    // QUOTES
    const quotes = [
        "We suffer more often in imagination than in reality. ‚Äì Seneca",
        "It is not death that a man should fear, but he should fear never beginning to live. ‚Äì Marcus Aurelius",
        "No man is free who is not a master of himself. ‚Äì Epictetus",
        "To be calm is the highest achievement of the self. ‚Äì Zen Proverb",
        "Discipline is choosing between what you want now and what you want most. ‚Äì Abraham Lincoln",
        "The impediment to action advances action. What stands in the way becomes the way. ‚Äì Marcus Aurelius",
        "Waste no more time arguing about what a good man should be. Be one. ‚Äì Marcus Aurelius",
        "He who has a why to live can bear almost any how. ‚Äì Friedrich Nietzsche"
    ];

    window.onload = function() {
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
        document.getElementById('quoteDisplay').innerText = randomQuote;
        migrateData(); 
        loadHistoryTable();
        calculateStreak();
        updateLevelXP(); 
        updateCurrentActivity();
        calculateWeeklyAverages();
        loadLongTerm();
        setInterval(updateCurrentActivity, 1000); 
        const registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
        const todayRecords = registry.filter(id => {
            const data = JSON.parse(localStorage.getItem(id));
            return data && data.date === todayKey;
        });
        if (todayRecords.length > 0) {
            const lastId = todayRecords[todayRecords.length - 1];
            populateForm(JSON.parse(localStorage.getItem(lastId)));
        }
    };

    function updateLongTerm(type, value) {
        if(type === 'thesis') document.getElementById('thesisPercent').innerText = value + '%';
        if(type === 'hec') document.getElementById('hecPercent').innerText = 'Day ' + value;
        const longTermData = JSON.parse(localStorage.getItem('tracker_longterm') || "{}");
        longTermData[type] = value;
        localStorage.setItem('tracker_longterm', JSON.stringify(longTermData));
    }

    function loadLongTerm() {
        const data = JSON.parse(localStorage.getItem('tracker_longterm') || "{}");
        if(data.thesis) {
            document.getElementById('thesisProgress').value = data.thesis;
            document.getElementById('thesisPercent').innerText = data.thesis + '%';
        }
        if(data.hec) {
            document.getElementById('hecProgress').value = data.hec;
            document.getElementById('hecPercent').innerText = 'Day ' + data.hec;
        }
    }

    // --- ANALYTICS ENGINE (V3.12 ROBUST SINGLE-DATA LOGIC) ---
    
    function calculateWeeklyAverages() {
        let registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
        let last30 = registry.slice(-30); 
        let last7 = registry.slice(-7);
        
        // --- FIX: Always render charts even if data is 1 item ---
        // We only skip if TRUE empty
        if(document.getElementById('historyView').style.display !== 'none') {
            drawTrendChart(last30); 
            drawRadarChart(last7);  
            renderHeatmap(registry); 
            generateInsight(last30);
        }

        // Handle empty data case for stats only
        if (last7.length === 0) {
            updateStatDisplay(0, 0, 0, {score: 0, date: '--'});
            return;
        }

        // 1. Calculate Stats
        let stats = { score: 0, deep: 0, sleep: 0, bestDay: {score:0, date:''} };
        last7.forEach(id => {
            const d = JSON.parse(localStorage.getItem(id));
            const sc = parseInt(d.totalScore || 0);
            stats.score += sc;
            if(sc > stats.bestDay.score) { stats.bestDay = {score: sc, date: d.date.slice(5)}; }
            
            const work = (parseFloat(d.inputs.s1_time||0) + parseFloat(d.inputs.s2_time||0) + parseFloat(d.inputs.s3_time||0));
            stats.deep += work;
            
            // Sleep calc
            let sleepS = 0;
            const bedTime = d.inputs.bedTime;
            if(bedTime) {
                const [h, m] = bedTime.split(':').map(Number);
                let timeVal = h + m/60;
                if (h < 6) timeVal += 24;
                if (timeVal < 22.08) sleepS = 15;
                else if (timeVal < 23) sleepS = 9;
                else if (timeVal < 24) sleepS = 0;
            }
            stats.sleep += sleepS;
        });

        // 2. Render Cards
        updateStatDisplay(
            Math.round(stats.score / last7.length),
            (stats.deep / 60).toFixed(1),
            Math.round(stats.sleep / last7.length),
            stats.bestDay
        );
    }

    function updateStatDisplay(score, deep, sleep, best) {
        document.getElementById('wkAvgScore').innerText = score;
        document.getElementById('wkTotalDeep').innerText = deep + "h";
        document.getElementById('wkAvgSleep').innerText = sleep;
        // Check if best exists to prevent error
        if(best && best.score) {
            document.getElementById('wkBestDay').innerText = `${best.score} (${best.date})`;
        } else {
            document.getElementById('wkBestDay').innerText = "--";
        }
        document.getElementById('trendScore').innerHTML = `<span class="trend-up">‚Üë Recent Activity</span>`;
    }

    function drawTrendChart(dataList) {
        const canvas = document.getElementById('trendCanvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.parentElement.clientWidth;
        const H = canvas.parentElement.clientHeight;
        canvas.width = W; canvas.height = H;

        // Clear
        ctx.clearRect(0, 0, W, H);

        // --- EMPTY STATE HANDLING ---
        if (dataList.length === 0) {
            ctx.fillStyle = '#94a3b8';
            ctx.font = "14px Inter";
            ctx.textAlign = "center";
            ctx.fillText("No Data Yet", W/2, H/2);
            return;
        }

        // Data Prep
        const points = dataList.map(id => {
            const d = JSON.parse(localStorage.getItem(id));
            const score = parseInt(d.totalScore || 0);
            const work = (parseFloat(d.inputs.s1_time||0) + parseFloat(d.inputs.s2_time||0) + parseFloat(d.inputs.s3_time||0)) / 60; // Hours
            return { date: d.date.slice(8), score: score, work: work }; // Day only
        });

        // Config
        const pad = 40;
        const chartW = W - pad*2;
        const chartH = H - pad*2;
        // Handle single point spacing by defaulting stepX to 0, logic handled in loop
        const stepX = points.length > 1 ? chartW / (points.length - 1) : 0;

        // Draw Axes
        ctx.beginPath();
        ctx.strokeStyle = '#e2e8f0';
        ctx.lineWidth = 1;
        // Y-Axis lines (0, 50, 100)
        [0, 0.5, 1].forEach(r => {
            const y = pad + chartH - (r * chartH);
            ctx.moveTo(pad, y);
            ctx.lineTo(W - pad, y);
            ctx.fillStyle = '#94a3b8';
            ctx.font = "10px Inter";
            ctx.fillText(Math.round(r*100), 10, y + 3);
        });
        ctx.stroke();

        // If Single Data Point: Draw a "Mastery" reference line at 100 to give context to the dot
        if (points.length === 1) {
             const y100 = pad + chartH - (1 * chartH); // 100 score line
             ctx.beginPath();
             ctx.strokeStyle = 'rgba(16, 185, 129, 0.2)'; // Green tint
             ctx.setLineDash([5, 5]);
             ctx.moveTo(pad, y100);
             ctx.lineTo(W - pad, y100);
             ctx.stroke();
             ctx.setLineDash([]); // Reset
        }

        // 1. Draw Deep Work Bars (Secondary Axis 0-6h)
        const maxWork = 6; 
        // Adjust bar width based on count, CAP width for single item
        const barW = points.length > 1 ? (chartW / points.length) * 0.4 : 50; 
        
        points.forEach((p, i) => {
            // If single point, center it. If multiple, space them out.
            const x = points.length > 1 ? pad + (i * stepX) : W / 2;
            const h = (Math.min(p.work, maxWork) / maxWork) * chartH;
            const y = pad + chartH - h;
            
            ctx.fillStyle = 'rgba(59, 130, 246, 0.2)'; 
            ctx.fillRect(x - barW/2, y, barW, h);
        });

        // 2. Draw Score Line
        if (points.length > 1) {
            ctx.beginPath();
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 3;
            ctx.shadowBlur = 10;
            ctx.shadowColor = "rgba(59, 130, 246, 0.4)";
            points.forEach((p, i) => {
                const x = pad + (i * stepX);
                const y = pad + chartH - ((p.score / 120) * chartH); // 120 is max scale for visual room
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        // Points
        points.forEach((p, i) => {
            const x = points.length > 1 ? pad + (i * stepX) : W / 2;
            const y = pad + chartH - ((p.score / 120) * chartH);
            ctx.beginPath();
            ctx.fillStyle = '#ffffff';
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#3b82f6'; // Ensure stroke color is explicit
            ctx.stroke();
            
            // Labels: Always draw if count < 10, otherwise skip some
            if(points.length < 10 || i % 2 === 0) {
                ctx.fillStyle = '#64748b';
                ctx.textAlign = "center";
                ctx.fillText(p.date, x, H - 10);
            }
        });
    }

    function drawRadarChart(dataList) {
        const canvas = document.getElementById('radarCanvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.parentElement.clientWidth;
        const H = canvas.parentElement.clientHeight;
        canvas.width = W; canvas.height = H;

        // Draw Config
        const cx = W / 2;
        const cy = H / 2;
        const radius = Math.min(W, H) / 2 - 40;
        const sides = 5;
        const angleStep = (Math.PI * 2) / sides;
        const labels = ["Work", "Sleep", "Diet", "Flow", "Discipline"];

        // Clear
        ctx.clearRect(0, 0, W, H);

        // Background Web (Always Draw)
        ctx.strokeStyle = '#e2e8f0';
        ctx.lineWidth = 1;
        for (let level = 1; level <= 4; level++) {
            ctx.beginPath();
            const r = (radius / 4) * level;
            for (let i = 0; i <= sides; i++) {
                const angle = i * angleStep - Math.PI / 2;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.stroke();
        }

        // Labels (Always Draw)
        ctx.fillStyle = '#475569';
        ctx.font = "11px Poppins";
        ctx.textAlign = "center";
        labels.forEach((label, i) => {
            const angle = i * angleStep - Math.PI / 2;
            const x = cx + Math.cos(angle) * (radius + 20);
            const y = cy + Math.sin(angle) * (radius + 20);
            ctx.fillText(label, x, y + 4);
        });

        // --- EMPTY STATE HANDLING ---
        if (dataList.length === 0) {
            ctx.fillStyle = '#94a3b8';
            ctx.font = "14px Inter";
            ctx.fillText("No Data", cx, cy);
            return;
        }

        // Aggregates
        let agg = { deep: 0, sleep: 0, diet: 0, focus: 0, disc: 0 };
        dataList.forEach(id => {
            const d = JSON.parse(localStorage.getItem(id));
            agg.deep += Math.min(((parseFloat(d.inputs.s1_time)+parseFloat(d.inputs.s2_time)+parseFloat(d.inputs.s3_time))/360), 1); 
            
            let sScore = 0; 
            const bed = d.inputs.bedTime;
            if(bed && parseInt(bed.split(':')[0]) < 22) sScore = 1; else sScore = 0.5; 
            agg.sleep += sScore;

            agg.diet += (parseInt(d.inputs.dietScoreInput||5) / 10);
            agg.focus += (parseInt(d.inputs.flowState||5) / 10);
            agg.disc += (parseInt(d.inputs.maturitylevel) >= 0 ? 1 : 0.4); 
        });

        const count = dataList.length;
        // Logic holds for count = 1. Division by 1 returns the exact value.
        const stats = [
            agg.deep / count,
            agg.sleep / count,
            agg.diet / count,
            agg.focus / count,
            agg.disc / count
        ];

        // Draw Data Shape
        ctx.beginPath();
        stats.forEach((val, i) => {
            const angle = i * angleStep - Math.PI / 2;
            const r = radius * val;
            const x = cx + Math.cos(angle) * r;
            const y = cy + Math.sin(angle) * r;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.closePath();
        ctx.fillStyle = 'rgba(139, 92, 246, 0.2)'; // Purple tint
        ctx.fill();
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    function renderHeatmap(registry) {
        const container = document.getElementById('heatmapContainer');
        container.innerHTML = "";
        
        // Generate last 30 days slots
        const today = new Date();
        const dates = [];
        for(let i=29; i>=0; i--) {
            const d = new Date();
            d.setDate(today.getDate() - i);
            dates.push(d.toISOString().split('T')[0]);
        }

        // Create Map of Score Data
        const scoreMap = {};
        registry.forEach(id => {
            const d = JSON.parse(localStorage.getItem(id));
            scoreMap[d.date] = parseInt(d.totalScore || 0);
        });

        dates.forEach(date => {
            const div = document.createElement('div');
            const score = scoreMap[date] || 0;
            div.className = 'hm-cell';
            
            // Color Logic
            if(score === 0) div.classList.add('hm-l0');
            else if(score < 50) div.classList.add('hm-l1');
            else if(score < 80) div.classList.add('hm-l2');
            else if(score < 100) div.classList.add('hm-l3');
            else div.classList.add('hm-l4');

            // Tooltip
            div.innerHTML = `<div class="hm-tooltip">${date}: ${score} pts</div>`;
            container.appendChild(div);
        });
    }

    function generateInsight(dataList) {
        const box = document.getElementById('aiInsightText');
        if(dataList.length === 0) {
            box.innerHTML = "No data yet. Start tracking to see insights.";
            return;
        }

        // Simplified insight for low data
        if(dataList.length < 3) {
             const latest = JSON.parse(localStorage.getItem(dataList[dataList.length-1]));
             const score = parseInt(latest.totalScore || 0);
             if(score > 80) box.innerHTML = `<strong>Insight:</strong> Excellent start! You scored <strong>${score}</strong> on your first logged day. Maintain this momentum!`;
             else box.innerHTML = `<strong>Insight:</strong> You've started the journey. Small steps every day lead to mastery. Consistency is your next goal.`;
             return;
        }

        // Simple Correlation Logic
        let highSleepScores = 0, lowSleepScores = 0;
        let highSleepCount = 0, lowSleepCount = 0;

        dataList.forEach(id => {
            const d = JSON.parse(localStorage.getItem(id));
            const score = parseInt(d.totalScore);
            // Check Bedtime
            const bed = d.inputs.bedTime;
            if(bed) {
                const h = parseInt(bed.split(':')[0]);
                if(h >= 20 && h <= 22) { // "Early" sleep
                    highSleepScores += score;
                    highSleepCount++;
                } else {
                    lowSleepScores += score;
                    lowSleepCount++;
                }
            }
        });

        if(highSleepCount > 0 && lowSleepCount > 0) {
            const avgHigh = highSleepScores / highSleepCount;
            const avgLow = lowSleepScores / lowSleepCount;
            const diff = Math.round(((avgHigh - avgLow) / avgLow) * 100);
            
            if(diff > 0) {
                box.innerHTML = `<strong>Insight:</strong> Sleeping before 10 PM correlates with a <strong>${diff}% higher score</strong>.`;
            } else {
                box.innerHTML = `<strong>Insight:</strong> Your scores are consistent regardless of sleep time. Focus on Deep Work intensity.`;
            }
        } else {
            box.innerHTML = `<strong>Insight:</strong> Data suggests consistent routines. Try increasing Deep Work intensity next.`;
        }
    }

    // --- EXISTING TIMER & UTILS ---
    let timerInterval;
    let timerSeconds = 0;
    let isTimerRunning = false;

    function startTimer() {
        if(isTimerRunning) return;
        isTimerRunning = true;
        document.getElementById('timerStatus').innerText = "FLOW STATE ENGAGED";
        document.getElementById('timerStatus').style.color = "#00f2ff";
        const startTime = Date.now() - (timerSeconds * 1000);
        timerInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            timerSeconds = Math.floor(elapsed / 1000);
            updateTimerDisplay();
        }, 1000);
    }

    function pauseTimer() {
        if(!isTimerRunning) return;
        clearInterval(timerInterval);
        isTimerRunning = false;
        document.getElementById('timerStatus').innerText = "PAUSED";
        document.getElementById('timerStatus').style.color = "#ffa502";
    }

    function stopTimer() {
        if(isTimerRunning) {
             clearInterval(timerInterval);
             isTimerRunning = false;
        }
        const targetId = document.getElementById('timerTarget').value;
        const currentVal = parseFloat(document.getElementById(targetId).value) || 0;
        const minutesAdded = Math.floor(timerSeconds / 60);
        if(minutesAdded > 0) {
            if(confirm(`Add ${minutesAdded} minutes to session log?`)) {
                const inputEl = document.getElementById(targetId);
                if(inputEl) {
                    inputEl.value = currentVal + minutesAdded;
                    calculateAll();
                    alert("Logged successfully.");
                }
                timerSeconds = 0;
                updateTimerDisplay();
                document.getElementById('timerStatus').innerText = "SESSION COMPLETE";
                document.getElementById('timerStatus').style.color = "#00b894";
            }
        } else {
            alert("Session too short to log (< 1 min).");
            timerSeconds = 0;
            updateTimerDisplay();
            document.getElementById('timerStatus').innerText = "READY";
        }
    }

    function updateTimerDisplay() {
        const m = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
        const s = (timerSeconds % 60).toString().padStart(2, '0');
        document.getElementById('timerDisplay').innerText = `${m}:${s}`;
    }

    function toggleZenMode() {
        const el = document.getElementById('focusModeContainer');
        el.classList.toggle('zen-mode-active');
        if(el.classList.contains('zen-mode-active')) {
            document.addEventListener('keydown', handleEscKey);
        } else {
            document.removeEventListener('keydown', handleEscKey);
        }
    }

    function handleEscKey(e) {
        if(e.key === "Escape") {
            const el = document.getElementById('focusModeContainer');
            if(el.classList.contains('zen-mode-active')) toggleZenMode();
        }
    }

    function toggleTheme() {
        const root = document.documentElement;
        const currentBg = getComputedStyle(root).getPropertyValue('--bg').trim();
        const isDark = currentBg === '#121212';
        if(!isDark) {
            root.style.setProperty('--bg', '#121212');
            root.style.setProperty('--paper', '#1e1e1e');
            root.style.setProperty('--text', '#ecf0f1');
            root.style.setProperty('--text-light', '#b2bec3');
            root.style.setProperty('--border', '#333');
            root.style.setProperty('--sched-bg', '#1e1e1e');
            root.style.setProperty('--sched-time-bg', '#1e1e1e');
        } else {
            root.style.setProperty('--bg', '#f1f5f9');
            root.style.setProperty('--paper', '#ffffff');
            root.style.setProperty('--text', '#0f172a');
            root.style.setProperty('--text-light', '#64748b');
            root.style.setProperty('--border', '#e2e8f0');
            root.style.setProperty('--sched-bg', '#f8fafc');
            root.style.setProperty('--sched-time-bg', '#ffffff');
        }
    }

    function migrateData() {
        const oldDates = JSON.parse(localStorage.getItem(OLD_INDEX_KEY) || "[]");
        let registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
        let changed = false;
        oldDates.forEach(date => {
            const oldKey = 'tracker_' + date;
            const data = localStorage.getItem(oldKey);
            if(data) {
                if(!registry.includes(oldKey)) {
                    registry.push(oldKey);
                    changed = true;
                }
            }
        });
        if(changed) localStorage.setItem(INDEX_KEY, JSON.stringify(registry));
    }

    function switchTab(tabName) {
        document.getElementById('trackerView').style.display = 'none';
        document.getElementById('historyView').style.display = 'none';
        document.getElementById('routineView').style.display = 'none';
        document.getElementById('focusView').style.display = 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const target = document.getElementById(tabName + 'View');
        target.style.display = 'block';
        target.style.animation = 'none';
        target.offsetHeight; 
        target.style.animation = 'fadeIn 0.4s ease';
        event.target.classList.add('active');
        if(tabName === 'history') {
            calculateWeeklyAverages(); // Triggers charts
        }
    }

    function calculateAll() {
        let total = 0;
        const wakeTime = document.getElementById('wakeTime').value;
        let wakeScore = 0;
        if(wakeTime) {
            const [h, m] = wakeTime.split(':').map(Number);
            const dec = h + m/60;
            if(dec < 6) wakeScore = 15;
            else if(dec < 7) wakeScore = 9; 
            else if(dec < 8) wakeScore = 6;
            else if(dec < 9) wakeScore = 0;
            else wakeScore = -6;
        }
        document.getElementById('wakeScore').innerText = wakeScore;
        total += wakeScore;
        const medTime = parseFloat(document.getElementById('meditationTime').value) || 0;
        let medScore = (medTime / 20) * 15;
        if(medScore > 15) medScore = 15;
        document.getElementById('meditationScore').innerText = Math.round(medScore);
        total += medScore;
        const bfScore = parseInt(document.getElementById('breakfastRating').value);
        document.getElementById('breakfastScore').innerText = bfScore;
        total += bfScore;
        let goalPoints = 0;
        if(document.getElementById('goal1_done').checked) goalPoints += 5;
        if(document.getElementById('goal2_done').checked) goalPoints += 5;
        if(document.getElementById('goal3_done').checked) goalPoints += 5;
        document.getElementById('goalScore').innerText = goalPoints;
        total += goalPoints;
        function calcSession(timeId, accId, outputId) {
            const T = parseFloat(document.getElementById(timeId).value) || 0;
            const A = parseFloat(document.getElementById(accId).value) || 0;
            let score = (0.48 * (T / 120) + 0.52 * (A / 100)) * 30;
            if(score > 30) score = 30;
            document.getElementById(outputId).innerText = Math.round(score);
            return score;
        }
        total += calcSession('s1_time', 's1_acc', 's1_score');
        total += calcSession('s2_time', 's2_acc', 's2_score');
        total += calcSession('s3_time', 's3_acc', 's3_score');
        const diet = parseInt(document.getElementById('dietScoreInput').value);
        total += diet;
        const water = parseFloat(document.getElementById('waterIntake').value);
        let waterScore = 0;
        if(water >= 3) waterScore = 5;
        else if(water >= 2) waterScore = 3;
        document.getElementById('waterScore').innerText = waterScore;
        total += waterScore;
        let medPoints = 0;
        if(document.getElementById('med_morning').checked) medPoints += 5;
        document.getElementById('medScore').innerText = medPoints;
        total += medPoints;
        const sHours = parseFloat(document.getElementById('screenHours').value) || 0;
        let screenScore = 25 - (1.6 * Math.pow(sHours, 1.6));
        if(screenScore < -20) screenScore = -20;
        document.getElementById('screenScore').innerText = Math.round(screenScore);
        total += screenScore;
        const N = parseFloat(document.getElementById('researchN').value) || 0;
        let rScore = 0.0833 * Math.pow(N,3) - 1.1429 * Math.pow(N,2) + 8.9881 * N;
        document.getElementById('researchScore').innerText = Math.round(rScore);
        total += rScore;
        let habitScore = parseInt(document.getElementById('maturitylevel').value);
        if(document.getElementById('rule_bed').checked) habitScore += 5;
        if(document.getElementById('rule_room').checked) habitScore += 5;
        document.getElementById('habitScore').innerText = habitScore;
        total += habitScore;
        const bedTime = document.getElementById('bedTime').value;
        let sleepScore = 0;
        if(bedTime) {
            const [h, m] = bedTime.split(':').map(Number);
            let timeVal = h + m/60;
            if (h < 6) timeVal += 24;
            if (timeVal < 22.08) sleepS = 15;
            else if (timeVal < 23) sleepS = 9;
            else if (timeVal < 24) sleepS = 0;
        }
        document.getElementById('sleepScore').innerText = Math.round(sleepScore);
        total += sleepScore;
        total = Math.round(total);
        document.getElementById('totalScore').innerText = total;
        const statusEl = document.getElementById('statusText');
        if (total >= 100) { statusEl.innerText = "GOD MODE"; statusEl.style.color = "#a55eea"; }
        else if (total >= 85) { statusEl.innerText = "LEGENDARY"; statusEl.style.color = "#00b894"; }
        else if (total >= 70) { statusEl.innerText = "GOOD"; statusEl.style.color = "#0984e3"; }
        else if (total >= 50) { statusEl.innerText = "SURVIVING"; statusEl.style.color = "#fdcb6e"; }
        else { statusEl.innerText = "CRITICAL"; statusEl.style.color = "#d63031"; }
    }

    function saveData() {
        const timestamp = new Date().getTime();
        const recordId = 'tracker_' + todayKey + '_' + timestamp;
        const total = parseInt(document.getElementById('totalScore').innerText);
        const data = {
            id: recordId,
            date: todayKey,
            timestamp: new Date().toLocaleString(),
            goals: [
                { text: document.getElementById('goal1').value, done: document.getElementById('goal1_done').checked },
                { text: document.getElementById('goal2').value, done: document.getElementById('goal2_done').checked },
                { text: document.getElementById('goal3').value, done: document.getElementById('goal3_done').checked }
            ],
            inputs: {
                wakeTime: document.getElementById('wakeTime').value,
                meditationTime: document.getElementById('meditationTime').value,
                breakfastRating: document.getElementById('breakfastRating').value,
                energyLevel: document.getElementById('energyLevel').value,
                s1_time: document.getElementById('s1_time').value,
                s1_acc: document.getElementById('s1_acc').value,
                s2_time: document.getElementById('s2_time').value,
                s2_acc: document.getElementById('s2_acc').value,
                s3_time: document.getElementById('s3_time').value,
                s3_acc: document.getElementById('s3_acc').value,
                dietScoreInput: document.getElementById('dietScoreInput').value,
                waterIntake: document.getElementById('waterIntake').value,
                med_morning: document.getElementById('med_morning').checked,
                screenHours: document.getElementById('screenHours').value,
                researchN: document.getElementById('researchN').value,
                maturitylevel: document.getElementById('maturitylevel').value,
                bedTime: document.getElementById('bedTime').value,
                rule_bed: document.getElementById('rule_bed').checked,
                rule_room: document.getElementById('rule_room').checked,
                dayTags: document.getElementById('dayTags').value,
                flowState: document.getElementById('flowState').value,
                moodSelect: document.getElementById('moodSelect').value,
                topWin: document.getElementById('topWin').value,
                mainObstacle: document.getElementById('mainObstacle').value
            },
            totalScore: total
        };
        localStorage.setItem(recordId, JSON.stringify(data));
        let registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
        registry.push(recordId);
        localStorage.setItem(INDEX_KEY, JSON.stringify(registry));
        if(total >= 100) { triggerConfetti(); alert("GOD MODE ACHIEVED! üèÜ"); } 
        else { alert("Saved."); }
        loadHistoryTable(); calculateStreak(); updateLevelXP(); calculateWeeklyAverages();
    }

    function triggerConfetti() {
        const canvas = document.getElementById('confettiCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const particles = [];
        const particleCount = 150;
        for (let i = 0; i < particleCount; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                w: Math.random() * 10 + 5,
                h: Math.random() * 10 + 5,
                color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                vx: Math.random() * 4 - 2,
                vy: Math.random() * 4 + 2,
                rotation: Math.random() * 360
            });
        }
        let animationId;
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.rotation += 2;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
                ctx.restore();
                if (p.y > canvas.height) particles.splice(i, 1);
            });
            if (particles.length > 0) { animationId = requestAnimationFrame(render); } 
            else { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        }
        render();
    }

    function updateLevelXP() {
        let registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
        let totalXP = 0;
        registry.forEach(id => {
            const d = JSON.parse(localStorage.getItem(id));
            if(d) totalXP += parseInt(d.totalScore || 0);
        });
        const level = Math.floor(totalXP / 500) + 1;
        const currentLevelXP = totalXP % 500;
        const percentage = (currentLevelXP / 500) * 100;
        document.getElementById('currentLevelText').innerHTML = `Lvl ${level} <span class="level-badge">Rank ${getRankName(level)}</span>`;
        document.getElementById('currentXP').innerText = currentLevelXP;
        document.getElementById('xpBarFill').style.width = percentage + "%";
    }

    function getRankName(lvl) {
        if(lvl < 5) return "Novice";
        if(lvl < 10) return "Apprentice";
        if(lvl < 20) return "Adept";
        if(lvl < 30) return "Expert";
        if(lvl < 50) return "Master";
        return "Grandmaster";
    }

    function resetForm() {
        if(confirm("Reset Form?")) {
            document.querySelectorAll('input').forEach(i => {
                if(i.type === 'checkbox') i.checked = false;
                else if(i.type === 'range') {
                    if(i.id === 'waterIntake') i.value = 2.5;
                    else if(i.id === 'energyLevel') i.value = 7;
                    else if(i.id === 'flowState') i.value = 5;
                    else i.value = 5;
                }
                else i.value = "";
            });
            document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            document.querySelectorAll('textarea').forEach(t => t.value = "");
            document.getElementById('energyDisp').innerText = "7";
            document.getElementById('dietDisp').innerText = "5";
            document.getElementById('waterDisp').innerText = "2.5";
            document.getElementById('flowDisp').innerText = "5";
            calculateAll();
        }
    }

    function populateForm(data) {
        if(!data) return;
        if(data.goals) {
            if(typeof data.goals[0] === 'string') {
                document.getElementById('goal1').value = data.goals[0] || "";
            } else {
                document.getElementById('goal1').value = data.goals[0].text || "";
                document.getElementById('goal1_done').checked = data.goals[0].done || false;
                document.getElementById('goal2').value = data.goals[1].text || "";
                document.getElementById('goal2_done').checked = data.goals[1].done || false;
                document.getElementById('goal3').value = data.goals[2].text || "";
                document.getElementById('goal3_done').checked = data.goals[2].done || false;
            }
        }
        if(data.inputs) {
            for(const key in data.inputs) {
                const el = document.getElementById(key);
                if(el) {
                    if(el.type === 'checkbox') el.checked = data.inputs[key];
                    else el.value = data.inputs[key];
                }
            }
            if(data.inputs.energyLevel) document.getElementById('energyDisp').innerText = data.inputs.energyLevel;
            if(data.inputs.dietScoreInput) document.getElementById('dietDisp').innerText = data.inputs.dietScoreInput;
            if(data.inputs.waterIntake) document.getElementById('waterDisp').innerText = data.inputs.waterIntake;
            if(data.inputs.flowState) document.getElementById('flowDisp').innerText = data.inputs.flowState;
        }
        calculateAll();
    }

    function loadHistoryTable() {
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = "";
        let registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
        const reversedRegistry = [...registry].reverse();
        reversedRegistry.forEach(id => {
            const dataStr = localStorage.getItem(id);
            if(!dataStr) return;
            const data = JSON.parse(dataStr);
            const tr = document.createElement('tr');
            const d1 = parseFloat(data.inputs.s1_time || 0);
            const d2 = parseFloat(data.inputs.s2_time || 0);
            const d3 = parseFloat(data.inputs.s3_time || 0);
            const totalWork = ((d1 + d2 + d3) / 60).toFixed(1);
            const score = parseInt(data.totalScore);
            let statusBadge = `<span class="status-pill" style="background:#ef4444; color:white;">CRITICAL</span>`;
            if (score >= 100) statusBadge = `<span class="status-pill" style="background:#8b5cf6; color:white;">GOD MODE</span>`;
            else if (score >= 85) statusBadge = `<span class="status-pill" style="background:#10b981; color:white;">LEGENDARY</span>`;
            else if (score >= 70) statusBadge = `<span class="status-pill" style="background:#3b82f6; color:white;">GOOD</span>`;
            else if (score >= 50) statusBadge = `<span class="status-pill" style="background:#f59e0b; color:white;">SURVIVING</span>`;
            const dateObj = new Date(data.date);
            const dateStr = dateObj.toLocaleDateString(undefined, { month:'short', day:'numeric' });
            const obstacle = data.inputs.mainObstacle ? `<span style="color:#ef4444; font-size:11px;">‚ö†Ô∏è ${data.inputs.mainObstacle}</span>` : `<span style="opacity:0.3">-</span>`;
            tr.innerHTML = `
                <td style="font-weight:600;">${dateStr}</td>
                <td style="opacity:0.8">${data.inputs.wakeTime || "-"}</td>
                <td><strong>${totalWork}h</strong></td>
                <td style="font-weight:800; font-family:'Poppins';">${data.totalScore}</td>
                <td>${statusBadge}</td>
                <td>${obstacle}</td>
                <td class="action-cell">
                    <button class="table-btn" onclick="loadRecord('${id}')" title="Load">üìÇ</button>
                    <button class="table-btn" onclick="deleteRecord('${id}')" title="Delete" style="color:var(--danger)">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function calculateStreak() {
        let registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
        let dates = registry.map(id => {
            const d = JSON.parse(localStorage.getItem(id));
            return d.date;
        });
        let uniqueDates = [...new Set(dates)].sort();
        if(uniqueDates.length === 0) { document.getElementById('streakCount').innerText = 0; return; }
        let streak = 0;
        let today = new Date().toISOString().split('T')[0];
        let yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        const lastEntry = uniqueDates[uniqueDates.length - 1];
        if (lastEntry !== today && lastEntry !== yesterday) {
            streak = 0;
        } else {
            streak = 1;
            for(let i = uniqueDates.length - 1; i > 0; i--) {
                const curr = new Date(uniqueDates[i]);
                const prev = new Date(uniqueDates[i-1]);
                const diffTime = Math.abs(curr - prev);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                if(diffDays === 1) streak++;
                else break;
            }
        }
        document.getElementById('streakCount').innerText = streak + " üî•";
    }

    function updateCurrentActivity() {
        const now = new Date();
        const day = now.getDay(); 
        const hour = now.getHours();
        const min = now.getMinutes();
        const timeVal = hour + min/60;

        document.getElementById('clockDisplay').innerText = now.toLocaleTimeString();

        // 1. UPDATE BADGE & STATUS
        let status = "FREE TIME / SLEEP";
        let color = "#b2bec3"; 
        if (timeVal >= 22 || timeVal < 6) { status = "‚ö†Ô∏è SLEEP WARNING!"; color = "#ef4444"; }
        else if (day === 6) { // SAT
            if (timeVal >= 6 && timeVal < 7) { status = "HIKE PREP"; color = "#f59e0b"; }
            else if (timeVal >= 7 && timeVal < 11) { status = "HIKING / SPORT"; color = "#ea580c"; }
            else if (timeVal >= 11 && timeVal < 14) { status = "REVIEW / PLANNING"; color = "#f59e0b"; }
            else if (timeVal >= 14 && timeVal < 19) { status = "SOCIAL / RELAX"; color = "#10b981"; }
            else if (timeVal >= 19 && timeVal < 20) { status = "DINNER"; color = "#e67e22"; }
            else if (timeVal >= 20 && timeVal < 21) { status = "PROJECT WORK"; color = "#8b5cf6"; } 
            else if (timeVal >= 21) { status = "DIGITAL SUNSET"; color = "#334155"; }
        } 
        else { // SUN-FRI
            if (timeVal >= 6 && timeVal < 7) { status = "MORNING PROTOCOL"; color = "#10b981"; }
            else if (timeVal >= 7 && timeVal < 8.75) { status = "COMMUTE / COLLEGE"; color = "#64748b"; }
            else if (timeVal >= 8.75 && timeVal < 10.25) { status = "LECTURES"; color = "#3b82f6"; }
            else if (timeVal >= 10.25 && timeVal < 11) { status = "BREAK"; color = "#f59e0b"; }
            else if (timeVal >= 11 && timeVal < 12.5) { status = "THESIS (DEEP I)"; color = "#f43f5e"; }
            else if (timeVal >= 12.5 && timeVal < 13.5) { status = "LUNCH"; color = "#10b981"; }
            else if (timeVal >= 13.5 && timeVal < 14.5) { status = "HEC-RAS HOUR"; color = "#3b82f6"; }
            else if (timeVal >= 14.5 && timeVal < 16.5) { status = "SKILL / RESEARCH"; color = "#334155"; }
            else if (timeVal >= 16.5 && timeVal < 17.5) { status = "COMMUTE"; color = "#64748b"; }
            else if (timeVal >= 17.5 && timeVal < 19) { status = "GYM / SPORT"; color = "#10b981"; }
            else if (timeVal >= 19 && timeVal < 20) { status = "DINNER"; color = "#e67e22"; }
            else if (timeVal >= 20 && timeVal < 21) { status = "PYTHON / ML"; color = "#f59e0b"; }
            else if (timeVal >= 21) { status = "DIGITAL SUNSET"; color = "#334155"; }
        }
        const badge = document.getElementById('currentActivityBadge');
        badge.innerText = status;
        badge.style.borderColor = color;
        badge.style.boxShadow = `0 0 10px ${color}`;
        badge.style.textShadow = `0 0 5px ${color}`;
        badge.style.border = `1px solid ${color}`;

        // 2. DYNAMIC TABLE HIGHLIGHTING
        document.querySelectorAll('.active-routine-cell').forEach(el => {
            el.classList.remove('active-routine-cell');
        });
        document.querySelectorAll('.active-day-header').forEach(el => el.classList.remove('active-day-header'));

        let rowHour = hour;
        if(hour < 6) rowHour = 22; 
        else if(hour >= 22) rowHour = 22;
        
        let rowId = null;
        let checkH = rowHour;
        let found = false;
        
        while(checkH >= 6 && !found) {
            let id = 'row-' + (checkH < 10 ? '0' : '') + checkH;
            let el = document.getElementById(id);
            if(el) {
                rowId = id;
                found = true;
            }
            checkH--;
        }
        const colIndex = day + 1;
        const table = document.querySelector('.routine-table');
        if(table) {
            const headerRow = table.querySelector('thead tr');
            if(headerRow && headerRow.children[colIndex]) {
                headerRow.children[colIndex].classList.add('active-day-header');
            }
            
            if(rowId) {
                const tr = document.getElementById(rowId);
                let currentCellIndex = 0;
                let visualCol = 0;
                let targetCell = null;

                for(let i=0; i < tr.children.length; i++) {
                    const cell = tr.children[i];
                    let colspan = parseInt(cell.getAttribute('colspan') || 1);
                    if(colIndex >= visualCol && colIndex < (visualCol + colspan)) {
                        targetCell = cell.querySelector('.rt-card') || cell; 
                        break;
                    }
                    visualCol += colspan;
                }

                if(targetCell) {
                    targetCell.classList.add('active-routine-cell');
                }
            }
        }
    }

    function exportToCSV() {
        let registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
        if (registry.length === 0) { alert("No data to export."); return; }
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Date,Time,WakeTime,DeepWorkMinutes,ScreenTime,L_Penalty,WaterIntake,EnergyLevel,FlowState,Mood,TotalScore,TopWin,MainObstacle,Tags\n";
        registry.forEach(id => {
            const d = JSON.parse(localStorage.getItem(id));
            if(d && d.inputs) {
                let work = (parseFloat(d.inputs.s1_time)||0) + (parseFloat(d.inputs.s2_time)||0) + (parseFloat(d.inputs.s3_time)||0);
                let time = d.timestamp ? d.timestamp.replace(',', '') : '00:00:00';
                let tags = (d.inputs.dayTags || "").replace(/,/g, " ");
                let obstacle = (d.inputs.mainObstacle || "").replace(/,/g, " ");
                let row = `${d.date},${time},${d.inputs.wakeTime},${work},${d.inputs.screenHours},${d.inputs.maturitylevel},${d.inputs.waterIntake || 0},${d.inputs.energyLevel || 0},${d.inputs.flowState || 0},${d.inputs.moodSelect || '-'},${d.totalScore},"${d.inputs.topWin || ''}","${obstacle}","${tags}"`;
                csvContent += row + "\r\n";
            }
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "bibek_master_protocol.csv");
        document.body.appendChild(link);
        link.click();
    }

    function exportJSON() {
        let registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
        if (registry.length === 0) { alert("No data to export."); return; }
        let allData = { registry: registry, entries: {} };
        registry.forEach(id => {
            allData.entries[id] = JSON.parse(localStorage.getItem(id));
        });
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData));
        const link = document.createElement("a");
        link.setAttribute("href", dataStr);
        link.setAttribute("download", "bibek_tracker_backup.json");
        document.body.appendChild(link);
        link.click();
    }

    function exportToExcel() {
        let registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
        if (registry.length === 0) { alert("No data to export."); return; }
        let table = `
            <table border="1">
                <thead>
                    <tr style="background-color: #1e293b; color: white;">
                        <th>Date</th><th>Time</th><th>Wake Time</th><th>Deep Work (min)</th>
                        <th>Screen Time</th><th>L Score</th><th>Water (L)</th>
                        <th>Energy (1-10)</th><th>Flow (1-10)</th><th>Mood</th>
                        <th>Total Score</th><th>Top Win</th><th>Main Obstacle</th>
                    </tr>
                </thead>
                <tbody>
        `;
        registry.forEach(id => {
            const d = JSON.parse(localStorage.getItem(id));
            if(d && d.inputs) {
                let work = (parseFloat(d.inputs.s1_time)||0) + (parseFloat(d.inputs.s2_time)||0) + (parseFloat(d.inputs.s3_time)||0);
                let time = d.timestamp ? d.timestamp.replace(',', '') : '00:00:00';
                table += `<tr>
                    <td>${d.date}</td>
                    <td>${time}</td>
                    <td>${d.inputs.wakeTime || '-'}</td>
                    <td>${work}</td>
                    <td>${d.inputs.screenHours}</td>
                    <td>${d.inputs.maturitylevel}</td>
                    <td>${d.inputs.waterIntake || 0}</td>
                    <td>${d.inputs.energyLevel || 0}</td>
                    <td>${d.inputs.flowState || 0}</td>
                    <td>${d.inputs.moodSelect || '-'}</td>
                    <td><b>${d.totalScore}</b></td>
                    <td>${d.inputs.topWin || ''}</td>
                    <td>${d.inputs.mainObstacle || ''}</td>
                </tr>`;
            }
        });
        table += `</tbody></table>`;
        const blob = new Blob([table], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "Bibek_Tracker_Excel.xls";
        document.body.appendChild(link);
        link.click();
    }

    function importJSON() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.readAsText(file, 'UTF-8');
            reader.onload = readerEvent => {
                const content = readerEvent.target.result;
                try {
                    const parsed = JSON.parse(content);
                    if(parsed.registry && parsed.entries) {
                        if(confirm("Merge imported data?")) {
                            let currentRegistry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
                            parsed.registry.forEach(id => {
                                if(!currentRegistry.includes(id)) currentRegistry.push(id);
                                localStorage.setItem(id, JSON.stringify(parsed.entries[id]));
                            });
                            localStorage.setItem(INDEX_KEY, JSON.stringify(currentRegistry));
                            alert("Import Successful! Reloading...");
                            location.reload();
                        }
                    } else {
                        alert("Invalid JSON format");
                    }
                } catch(err) {
                    alert("Error parsing JSON");
                }
            }
        }
        input.click();
    }

    window.loadRecord = function(id) {
        if(confirm("Load log?")) {
            const data = JSON.parse(localStorage.getItem(id));
            populateForm(data);
            switchTab('tracker');
        }
    }
    
    window.deleteRecord = function(id) {
        if(confirm("Delete log?")) {
            localStorage.removeItem(id);
            let registry = JSON.parse(localStorage.getItem(INDEX_KEY) || "[]");
            registry = registry.filter(item => item !== id);
            localStorage.setItem(INDEX_KEY, JSON.stringify(registry));
            loadHistoryTable();
            calculateStreak();
            updateLevelXP();
            calculateWeeklyAverages();
        }
    }

    window.clearHistory = function() {
        if(confirm("üî• RESET EVERYTHING?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
